# Get edgar accesion numbers of annual reports on edgar
namespace :seed do
  desc "Seed stocks and accesions for 10-ks"

  task :cik_and_acns => :environment do |task, args|
    require 'active_record'

    file = File.open("accession_numbers.txt","r")

    # skip first line wich is just a title
    lines = file.lines
    lines.next

    lines.each do |line|

      if line.first == "N"
        name, ticker, cik =
          line.scan(/Name: (.+) ; Ticker: (.+) ; CIK: (\d+).+/)[0]

        stock = Stock.create(:name => name,
                             :ticker => ticker,
                             :cik => cik)

        # write errors to erro log
      else
        year,acn = line.scan(/YEAR (\d+) ; ACN (.+)/)[0]
        fil = Filing.create(:stock => stock,
                            :year => year,
                            :filing_type => "k10",
                            :acn => acn)

      end
    end


    file.close
  end # task

  task :check => :environment do |task, args|


  end # task
  
  def generate_links(ticker)
    file = File.open("accession_numbers.txt","r")
    lines = file.lines
    list = nil
    at_line = false
    lines.next # get rid of first line
    lines.each do |line|

      if at_line == false && get_ticker(line) == ticker.strip
        cik = line.split(";")[2][/ CIK: (?<tik>.*)/,"tik"].strip
        list = AcnList.new(ticker,cik)
        at_line = true
      end
      if at_line
        break if line.first == "N"
        year, acn = retrieve_acn_info
        list.add(Acn.new(year,list.cik,acn))
      end
    end

    file.close
    list
  end

  def get_ticker(line)
    tik = line.split(";")[1][/ Ticker: (?<tik>.*)/,"tik"]
    return "" if tik.nil?
    tik.strip
  end

  def retrieve_acn_info(line)
    acn_data = []
    acn_data << line.split(";")[0][/YEAR (?<tik>.*)/,"tik"].strip
    acn_data << line.split(";")[1][/ACN (?<tik>.*)/,"tik"].strip
    acn_data
  end




class Acn
  attr_accessor :ticker, :year, :acn, :cik

  def initialize(year,cik,acn)
    @year = year
    @acn = acn
    @cik = cik
  end

  def url
    "http://www.sec.gov/Archives/edgar/data/#{cik}/#{acn}.txt"
  end
end

class AcnList
  attr_accessor :ticker, :cik, :list

  def initialize(ticker, cik)
    @ticker = ticker
    @cik = cik
    @list = []
  end

  def add(acn)
    @list << acn
  end
end

end # namdspace
